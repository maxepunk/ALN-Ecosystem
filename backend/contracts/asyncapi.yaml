asyncapi: 2.6.0

info:
  title: ALN Orchestrator WebSocket API
  version: 1.0.0
  description: |
    About Last Night (ALN) Orchestrator WebSocket API for real-time game state synchronization.

    **Architecture**: Contract-First approach with wrapped event envelope pattern.

    **Components**:
    - GM Scanner: Real-time game logic via WebSocket
    - Admin Panel: Monitoring and intervention via WebSocket commands

    **Key Patterns**:
    - All events use wrapped envelope: `{event, data, timestamp}`
    - Authentication via Socket.io handshake (JWT from HTTP POST /api/admin/auth)
    - ONE session at a time (2-hour live event)
    - Real-time state sync via sync:full event

    **Authentication Flow**:
    This API uses Socket.io handshake authentication (NOT application-level auth events).

    1. Client obtains JWT token via HTTP POST /api/admin/auth (see OpenAPI spec)
    2. Client connects WebSocket with credentials in `handshake.auth` object:
       ```javascript
       {
         token: "JWT_TOKEN",           // Required: JWT from POST /api/admin/auth
         deviceId: "DEVICE_ID",        // Required: Unique device identifier
         deviceType: "gm" | "admin",   // Required: Device type for permissions
         version: "1.0.0"              // Optional: Client version string
       }
       ```
    3. Server validates JWT in Socket.io middleware during connection handshake
    4. **Success**: Connection established → server registers device → broadcasts device:connected → auto-sends sync:full
    5. **Failure**: Connection rejected → client receives connect_error (transport-level, not application event)

    **Connection Rejection Reasons**:
    - Missing or malformed JWT token
    - Invalid JWT signature or expired token (> 24 hours)
    - Token revoked (logout/admin action)
    - Invalid deviceId or deviceType
    - Server at capacity (max GM stations reached)

    Note: Authentication errors occur at transport level (connect_error), not as application-level error events.

    **Documentation References**:
    - Alignment Decisions: docs/api-alignment/04-alignment-decisions.md
    - Functional Requirements: docs/api-alignment/08-functional-requirements.md
    - Essential API List: docs/api-alignment/09-essential-api-list.md

servers:
  production:
    url: ws://localhost:3000
    protocol: ws
    description: Local development WebSocket server
  network:
    url: ws://{orchestrator-ip}:3000
    protocol: ws
    description: Network deployment WebSocket server
    variables:
      orchestrator-ip:
        default: "10.0.0.100"
        description: Orchestrator IP address on local network

channels:
  /:
    description: Main WebSocket channel for all events
    subscribe:
      summary: Receive events from orchestrator
      description: |
        Server-to-client events (outgoing from orchestrator perspective).
        All events use wrapped envelope pattern per Decision #2.

        After successful handshake authentication, client automatically receives sync:full event.
      message:
        oneOf:
          - $ref: '#/components/messages/DeviceConnected'
          - $ref: '#/components/messages/DeviceDisconnected'
          - $ref: '#/components/messages/SyncFull'
          - $ref: '#/components/messages/TransactionResult'
          - $ref: '#/components/messages/TransactionNew'
          - $ref: '#/components/messages/TransactionDeleted'
          - $ref: '#/components/messages/ScoreUpdated'
          - $ref: '#/components/messages/ScoresReset'
          - $ref: '#/components/messages/VideoStatus'
          - $ref: '#/components/messages/SessionUpdate'
          - $ref: '#/components/messages/SessionOvertime'
          - $ref: '#/components/messages/GmCommandAck'
          - $ref: '#/components/messages/OfflineQueueProcessed'
          - $ref: '#/components/messages/GroupCompleted'
          - $ref: '#/components/messages/DisplayMode'
          - $ref: '#/components/messages/DisplayStatus'
          - $ref: '#/components/messages/BluetoothDevice'
          - $ref: '#/components/messages/BluetoothScan'
          - $ref: '#/components/messages/AudioRouting'
          - $ref: '#/components/messages/AudioRoutingFallback'
          - $ref: '#/components/messages/LightingScene'
          - $ref: '#/components/messages/LightingStatus'
          - $ref: '#/components/messages/GameClockStatus'
          - $ref: '#/components/messages/CueFired'
          - $ref: '#/components/messages/CueStatus'
          - $ref: '#/components/messages/CueCompleted'
          - $ref: '#/components/messages/CueError'
          - $ref: '#/components/messages/CueConflict'
          - $ref: '#/components/messages/SoundStatus'
          - $ref: '#/components/messages/SpotifyStatus'
          - $ref: '#/components/messages/Error'
    publish:
      summary: Send events to orchestrator
      description: |
        Client-to-server events (incoming from orchestrator perspective).
        All events use wrapped envelope pattern per Decision #2.

        Note: Authentication happens at connection time via Socket.io handshake, not via application-level events.
      message:
        oneOf:
          - $ref: '#/components/messages/TransactionSubmit'
          - $ref: '#/components/messages/GmCommand'

components:
  messages:
    # ============================================================================
    # DEVICE TRACKING (2 events)
    # Note: Authentication happens via Socket.io handshake middleware (not events)
    # ============================================================================

    DeviceConnected:
      name: device:connected
      title: Device Connection Broadcast
      summary: Broadcast when device connects
      description: |
        Broadcast to all connected clients when new device successfully authenticates and connects.

        **Trigger**: After successful Socket.io handshake authentication:
        1. Server middleware validates JWT in handshake.auth
        2. Connection accepted
        3. Device info extracted from handshake.auth
        4. DeviceConnection model created
        5. Device registered in current session (if exists)
        6. THIS EVENT broadcast to all OTHER connected clients
        7. sync:full sent to the newly connected device

        **Important**: This event is NOT sent to the connecting device itself,
        only broadcast to existing connected clients for awareness.

        **Functional Requirement**: Section 1.6 (Device Tracking)
        **Decisions Applied**: #2 (wrapped envelope), #4 (deviceId), #8 (send object not array)

        **CRITICAL - Decision #8**:
        Send single device object, NOT array.
        This event represents a SINGLE device connecting, not a list.
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: device:connected
            description: Event name
          data:
            type: object
            required:
              - deviceId
              - type
              - name
              - ipAddress
              - connectionTime
            properties:
              deviceId:
                type: string
                description: Device identifier (per Decision 4)
                example: "GM_Station_2"
              type:
                type: string
                enum: [gm, player]
                description: Device type
                example: "gm"
              name:
                type: string
                description: Friendly device name
                example: "GM Station v1.0.0"
              ipAddress:
                type: string
                description: Device IP address
                example: "10.0.0.82"
              connectionTime:
                type: string
                format: date-time
                description: Connection timestamp
                example: "2025-10-15T19:05:00.000Z"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:05:00.000Z"

    DeviceDisconnected:
      name: device:disconnected
      title: Device Disconnection Broadcast
      summary: Broadcast when device disconnects
      description: |
        Broadcast to all connected clients when device disconnects.

        **Functional Requirement**: Section 1.6 (Device Tracking)
        **Decisions Applied**: #2 (wrapped envelope), #4 (deviceId)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: device:disconnected
            description: Event name
          data:
            type: object
            required:
              - deviceId
              - reason
              - disconnectionTime
            properties:
              deviceId:
                type: string
                description: Device identifier
                example: "GM_Station_2"
              reason:
                type: string
                enum: [manual, timeout, error]
                description: Disconnection reason
                example: "timeout"
              disconnectionTime:
                type: string
                format: date-time
                description: Disconnection timestamp
                example: "2025-10-15T21:00:00.000Z"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T21:00:00.000Z"

    # ============================================================================
    # STATE SYNCHRONIZATION (1 event)
    # ============================================================================

    SyncFull:
      name: sync:full
      title: Complete State Synchronization
      summary: Send complete system state
      description: |
        Send complete system state to client. Richest payload event.

        **Functional Requirement**: Section 1.7 (State Synchronization)
        **Decisions Applied**: #2 (wrapped envelope), #5 (videoStatus structure), #7 (full session)

        **When Sent**:
        - Automatically on successful WebSocket connection (immediately after handshake authentication)
        - After offline queue processing completes
        - After admin commands that affect multiple state components
        - After session state changes requiring full resync

        **Initial Connection Behavior**:
        When a GM Scanner or Admin Panel successfully authenticates and connects,
        server automatically sends sync:full as the FIRST event. No request needed.
        This replaces the old gm:identified → sync:full pattern.

        **Replaces**:
        - state:sync event (eliminated per investigation - redundant)
        - state:update event (eliminated per Decision 6 - contract violation)

        **Note**: This is the PRIMARY state sync mechanism. HTTP GET /api/state is debug/recovery only.
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: sync:full
            description: Event name
          data:
            type: object
            required:
              - session
              - scores
              - recentTransactions
              - videoStatus
              - devices
              - systemStatus
            properties:
              session:
                description: Current session (matches Session schema from OpenAPI)
                oneOf:
                  - type: object
                    required:
                      - id
                      - name
                      - startTime
                      - status
                      - teams
                      - metadata
                    properties:
                      id:
                        type: string
                        format: uuid
                        example: "2a2f9d45-5d2d-441d-b32c-52c939f3c103"
                      name:
                        type: string
                        example: "About Last Night - Oct 15 2025"
                      startTime:
                        type: string
                        format: date-time
                        example: "2025-10-15T19:00:00.000Z"
                      endTime:
                        type: string
                        format: date-time
                        nullable: true
                        example: null
                      status:
                        type: string
                        enum: [setup, active, paused, ended]
                        example: "active"
                      teams:
                        type: array
                        items:
                          type: string
                        example: ["Team Alpha", "Detectives", "Blue Squad"]
                      metadata:
                        type: object
                        properties:
                          gmStations:
                            type: integer
                            description: Number of connected GM stations
                            example: 2
                          playerDevices:
                            type: integer
                            description: Number of connected player devices
                            example: 3
                          totalScans:
                            type: integer
                            description: Total number of scans in session
                            example: 47
                          uniqueTokensScanned:
                            type: array
                            items:
                              type: string
                            description: List of unique token IDs scanned
                            example: ["kaa001", "kaa002", "kaa003"]
                          scannedTokensByDevice:
                            type: object
                            description: Per-device scanned token tracking (Phase 1.1 P0.1)
                            additionalProperties:
                              type: array
                              items:
                                type: string
                            example:
                              GM_STATION_1: ["kaa001", "kaa002"]
                              PLAYER_001: ["kaa003", "kaa004"]
                  - type: "null"
              scores:
                type: array
                description: Team scores (matches GameState.scores from OpenAPI)
                items:
                  type: object
                  required:
                    - teamId
                    - currentScore
                    - baseScore
                    - bonusPoints
                    - tokensScanned
                    - completedGroups
                    - adminAdjustments
                    - lastUpdate
                  properties:
                    teamId:
                      type: string
                      example: "Team Alpha"
                    currentScore:
                      type: integer
                      example: 11500
                    baseScore:
                      type: integer
                      example: 11000
                    bonusPoints:
                      type: integer
                      example: 500
                    tokensScanned:
                      type: integer
                      example: 8
                    completedGroups:
                      type: array
                      items:
                        type: string
                      example: ["jaw_group"]
                    adminAdjustments:
                      type: array
                      items:
                        type: object
                        required:
                          - delta
                          - gmStation
                          - reason
                          - timestamp
                        properties:
                          delta:
                            type: integer
                            description: Score adjustment amount
                            example: -500
                          gmStation:
                            type: string
                            description: GM station that made the adjustment
                            example: "GM_Station_1"
                          reason:
                            type: string
                            description: Reason for adjustment
                            example: "Rule violation penalty"
                          timestamp:
                            type: string
                            format: date-time
                            description: When adjustment was made
                            example: "2025-10-24T10:30:00.000Z"
                      description: Array of admin score adjustments
                      example: []
                    lastUpdate:
                      type: string
                      format: date-time
                      example: "2025-10-15T20:15:30.000Z"
              recentTransactions:
                type: array
                description: Recent transactions (last 100)
                items:
                  type: object
                  required:
                    - id
                    - tokenId
                    - teamId
                    - deviceId
                    - mode
                    - points
                    - timestamp
                  properties:
                    id:
                      type: string
                      format: uuid
                      example: "7b8b1d85-b234-4be9-bde5-4c8522a1f15e"
                    tokenId:
                      type: string
                      example: "534e2b03"
                    teamId:
                      type: string
                      example: "Team Alpha"
                    deviceId:
                      type: string
                      example: "GM_Station_1"
                    mode:
                      type: string
                      enum: [detective, blackmarket]
                      example: "blackmarket"
                    points:
                      type: integer
                      example: 3000
                    timestamp:
                      type: string
                      format: date-time
                      example: "2025-10-15T20:15:30.000Z"
                    memoryType:
                      type: string
                      enum: [Technical, Business, Personal]
                      example: "Technical"
                    valueRating:
                      type: integer
                      minimum: 1
                      maximum: 5
                      example: 3
                    group:
                      type: string
                      example: "jaw_group"
              videoStatus:
                type: object
                description: Current video status (per Decision 5)
                required:
                  - status
                  - queueLength
                properties:
                  status:
                    type: string
                    enum: [idle, loading, playing, paused, completed, error]
                    example: "playing"
                  queueLength:
                    type: integer
                    description: Queue length (per Decision 5 - ADDED FIELD)
                    minimum: 0
                    example: 2
                  tokenId:
                    type: string
                    nullable: true
                    example: "534e2b03"
                  duration:
                    type: number
                    nullable: true
                    example: 30
                  progress:
                    type: number
                    nullable: true
                    minimum: 0
                    maximum: 100
                    example: 45
                  expectedEndTime:
                    type: string
                    format: date-time
                    nullable: true
                    example: "2025-10-15T20:16:00.000Z"
                  error:
                    type: string
                    nullable: true
                    example: null
              devices:
                type: array
                description: Connected devices
                items:
                  type: object
                  required:
                    - deviceId
                    - type
                    - name
                    - connectionTime
                  properties:
                    deviceId:
                      type: string
                      example: "GM_Station_1"
                    type:
                      type: string
                      enum: [gm, player]
                      example: "gm"
                    name:
                      type: string
                      example: "GM Station v1.0.0"
                    connectionTime:
                      type: string
                      format: date-time
                      example: "2025-10-15T19:00:30.000Z"
                    ipAddress:
                      type: string
                      example: "10.0.0.81"
              systemStatus:
                type: object
                description: System health status
                required:
                  - orchestrator
                  - vlc
                properties:
                  orchestrator:
                    type: string
                    enum: [online, offline]
                    example: "online"
                  vlc:
                    type: string
                    enum: [connected, disconnected, error]
                    example: "connected"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:00:30.200Z"

    # ============================================================================
    # TRANSACTIONS & SCORING (4 events)
    # ============================================================================

    TransactionSubmit:
      name: transaction:submit
      title: Submit Token Scan Transaction
      summary: GM Scanner submits token scan for scoring
      description: |
        GM Scanner submits token scan transaction for scoring calculation.

        **Functional Requirement**: Section 1.3 (Transaction Processing)
        **Decisions Applied**: #2 (wrapped envelope), #4 (tokenId, deviceId fields)

        **Flow**:
        1. Client sends transaction:submit
        2. Server validates and processes
        3. Server sends transaction:result to submitter
        4. Server broadcasts transaction:new to all GMs in session
        5. Server broadcasts score:updated to all GMs in session
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: transaction:submit
            description: Event name
          data:
            type: object
            required:
              - tokenId
              - teamId
              - deviceId
              - mode
            properties:
              tokenId:
                type: string
                description: Token ID (per Decision 4)
                example: "534e2b03"
              teamId:
                type: string
                description: Team ID (alphanumeric, 1-30 characters)
                example: "Team Alpha"
              deviceId:
                type: string
                description: GM Scanner device ID (per Decision 4)
                example: "GM_Station_1"
              mode:
                type: string
                enum: [detective, blackmarket]
                description: Scan mode (game logic)
                example: "blackmarket"
              summary:
                type: [string, "null"]
                description: Optional custom summary for detective mode scans (overrides token default)
                maxLength: 350
                example: "Security footage from warehouse district - timestamp 23:47"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:30.000Z"

    TransactionResult:
      name: transaction:result
      title: Transaction Processing Result
      summary: Server sends transaction result to submitter
      description: |
        Server sends transaction processing result to submitting device only.

        **Functional Requirement**: Section 1.3 (Transaction Processing)
        **Decisions Applied**: #2 (wrapped envelope), #10 (error display)

        **CRITICAL - Decision #10**:
        Client MUST check status field and display errors to user.
        Current scanner has bug (logs result but doesn't check status).
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: transaction:result
            description: Event name
          data:
            type: object
            required:
              - status
              - transactionId
              - tokenId
              - teamId
              - points
              - message
            properties:
              status:
                type: string
                enum: [accepted, duplicate, error]
                description: Transaction status
                example: "accepted"
              transactionId:
                type: string
                format: uuid
                description: Generated transaction ID
                example: "7b8b1d85-b234-4be9-bde5-4c8522a1f15e"
              tokenId:
                type: string
                description: Token ID
                example: "534e2b03"
              teamId:
                type: string
                description: Team ID
                example: "Team Alpha"
              points:
                type: integer
                description: Points awarded (0 if duplicate/error)
                example: 3000
              message:
                type: string
                description: User-friendly message
                example: "Transaction accepted - 3000 points awarded"
              error:
                type: string
                nullable: true
                description: Error code if status=error
                example: null
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:30.100Z"

    TransactionNew:
      name: transaction:new
      title: New Transaction Broadcast
      summary: Broadcast new transaction to all GMs in session
      description: |
        Broadcast new transaction to all GM Scanners in session for real-time updates.

        **Functional Requirement**: Section 1.3 (Transaction Processing - real-time broadcasting)
        **Decisions Applied**: #2 (wrapped envelope), #4 (tokenId, deviceId fields)

        **Note**: Backend enriches transaction with token metadata (memoryType, valueRating, group) from tokens.json.
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: transaction:new
            description: Event name
          data:
            type: object
            required:
              - transaction
            properties:
              transaction:
                type: object
                required:
                  - id
                  - tokenId
                  - teamId
                  - deviceId
                  - mode
                  - points
                  - timestamp
                properties:
                  id:
                    type: string
                    format: uuid
                    description: Transaction ID
                    example: "7b8b1d85-b234-4be9-bde5-4c8522a1f15e"
                  tokenId:
                    type: string
                    description: Token ID (per Decision 4)
                    example: "534e2b03"
                  teamId:
                    type: string
                    description: Team ID
                    example: "Team Alpha"
                  deviceId:
                    type: string
                    description: GM Scanner that created transaction (per Decision 4)
                    example: "GM_Station_1"
                  mode:
                    type: string
                    enum: [detective, blackmarket]
                    description: Scan mode
                    example: "blackmarket"
                  points:
                    type: integer
                    description: Points awarded
                    example: 3000
                  timestamp:
                    type: string
                    format: date-time
                    description: Transaction timestamp
                    example: "2025-10-15T20:15:30.000Z"
                  memoryType:
                    type: string
                    enum: [Technical, Business, Personal]
                    description: Token memory type (from tokens.json)
                    example: "Technical"
                  valueRating:
                    type: integer
                    minimum: 1
                    maximum: 5
                    description: Token value rating (from tokens.json)
                    example: 3
                  group:
                    type: string
                    description: Token group (from tokens.json)
                    example: "jaw_group"
                  summary:
                    type: [string, "null"]
                    description: Brief summary of memory content for detective mode (custom from transaction or default from tokens.json, optional)
                    maxLength: 350
                    example: "Security footage from warehouse district - timestamp 23:47"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:30.100Z"

    TransactionDeleted:
      name: transaction:deleted
      title: Transaction Deletion Broadcast
      summary: Broadcast transaction deletion to all GMs in session
      description: |
        Broadcast transaction deletion to all GM Scanners in session for real-time UI updates.
        Enables multi-device sync when an admin deletes a transaction from team history.

        **Scope**: Session-scoped broadcast (same as transaction:new) to prevent cross-session contamination.
        **Use Case**: Admin panel "Delete Transaction" action from team details screen.
        **Functional Requirement**: Section 1.3 (Transaction Processing - deletion support)
        **Decisions Applied**: #2 (wrapped envelope), #4 (tokenId, teamId fields)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: transaction:deleted
            description: Event name
          data:
            type: object
            required:
              - transactionId
              - teamId
              - tokenId
            properties:
              transactionId:
                type: string
                format: uuid
                description: Transaction ID being deleted
                example: "7b8b1d85-b234-4be9-bde5-4c8522a1f15e"
              teamId:
                type: string
                description: Team ID that owned the transaction
                example: "001"
              tokenId:
                type: string
                description: Token ID associated with deleted transaction
                example: "534e2b03"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:16:45.000Z"

    ScoreUpdated:
      name: score:updated
      title: Team Score Update Broadcast
      summary: Broadcast team score update to all GMs
      description: |
        Broadcast team score update to all GM Scanners for real-time leaderboard.

        **Functional Requirement**: Section 1.4 (Score Management)
        **Decisions Applied**: #2 (wrapped envelope)

        **CRITICAL**: All 8 fields REQUIRED with NO fallbacks (scanner expects complete data).
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: score:updated
            description: Event name
          data:
            type: object
            required:
              - teamId
              - currentScore
              - baseScore
              - bonusPoints
              - tokensScanned
              - completedGroups
              - adminAdjustments
              - lastUpdate
            properties:
              teamId:
                type: string
                description: Team ID
                example: "Team Alpha"
              currentScore:
                type: integer
                description: Total score (base + bonus)
                example: 11500
              baseScore:
                type: integer
                description: Base score from token values
                example: 11000
              bonusPoints:
                type: integer
                description: Bonus points from group completions
                example: 500
              tokensScanned:
                type: integer
                description: Number of tokens scanned
                example: 8
              completedGroups:
                type: array
                items:
                  type: string
                description: Array of completed group IDs
                example: ["jaw_group"]
              adminAdjustments:
                type: array
                items:
                  type: object
                  required:
                    - delta
                    - gmStation
                    - reason
                    - timestamp
                  properties:
                    delta:
                      type: integer
                      description: Score adjustment amount (positive or negative)
                      example: -500
                    gmStation:
                      type: string
                      description: GM station that made the adjustment
                      example: "GM_Station_1"
                    reason:
                      type: string
                      description: Reason for adjustment
                      example: "Rule violation penalty"
                    timestamp:
                      type: string
                      format: date-time
                      description: When adjustment was made
                      example: "2025-10-24T10:30:00.000Z"
                description: Array of admin score adjustments with audit trail
                example: [{"delta": -500, "gmStation": "GM_Station_1", "reason": "Rule violation penalty", "timestamp": "2025-10-24T10:30:00.000Z"}]
              lastUpdate:
                type: string
                format: date-time
                description: Last update timestamp
                example: "2025-10-15T20:15:30.000Z"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:30.100Z"

    ScoresReset:
      name: scores:reset
      title: All Team Scores Reset Broadcast
      summary: Broadcast score reset to all GMs in session
      description: |
        Broadcast to all GM Scanners in session when admin resets all team scores to zero.
        Followed immediately by sync:full event with complete updated state.

        **Scope**: Session-scoped broadcast (same as transaction:new/deleted) to prevent cross-session contamination.
        **Use Case**: Admin panel "Reset All Scores" action - nuclear option for score management.
        **Functional Requirement**: Section 1.4 (Score Management - admin controls)
        **Decisions Applied**: #2 (wrapped envelope)

        **Flow**:
        1. Admin triggers score:reset command via GM Scanner
        2. Backend resets all team scores in current session
        3. Backend broadcasts scores:reset to session
        4. Backend broadcasts sync:full with complete state
        5. All GMs in session clear scoreboards and re-sync
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: scores:reset
            description: Event name
          data:
            type: object
            required:
              - teamsReset
            properties:
              teamsReset:
                type: array
                items:
                  type: string
                  description: Array of team IDs that were reset
                example: ["Team Alpha", "Detectives", "Blue Squad"]
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:20:00.000Z"

    # ============================================================================
    # VIDEO ORCHESTRATION (1 event)
    # ============================================================================

    VideoStatus:
      name: video:status
      title: Video Playback Status Broadcast
      summary: Broadcast video playback status updates
      description: |
        Broadcast video playback status to all GM Scanners.

        **Functional Requirement**: Section 1.5.3 (Video Orchestration - State Broadcasting)
        **Decisions Applied**: #2 (wrapped envelope), #5 (FIXED STRUCTURE)

        **CRITICAL - Decision #5 Breaking Changes**:
        - Field rename: current → status
        - Added field: queueLength (REQUIRED)
        - Wrapped envelope (was unwrapped)

        **When Sent**:
        - Video starts playing
        - Video pauses/resumes
        - Video completes
        - Video error occurs
        - Queue changes
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: video:status
            description: Event name
          data:
            type: object
            required:
              - status
              - queueLength
            properties:
              status:
                type: string
                enum: [idle, loading, playing, paused, completed, error]
                description: Video playback status (per Decision 5 - renamed from 'current')
                example: "playing"
              queueLength:
                type: integer
                description: Number of videos in queue (per Decision 5 - ADDED FIELD)
                minimum: 0
                example: 2
              tokenId:
                type: string
                nullable: true
                description: Currently playing token ID (null if idle)
                example: "534e2b03"
              duration:
                type: number
                nullable: true
                description: Video duration in seconds
                example: 30
              progress:
                type: number
                nullable: true
                description: Playback progress percentage (0-100)
                minimum: 0
                maximum: 100
                example: 45
              expectedEndTime:
                type: string
                format: date-time
                nullable: true
                description: Expected completion time
                example: "2025-10-15T20:16:00.000Z"
              error:
                type: string
                nullable: true
                description: Error message if status=error
                example: null
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:45.000Z"

    # ============================================================================
    # DISPLAY CONTROL (2 events)
    # Phase 4.2: HDMI Display Control state machine
    # ============================================================================

    DisplayMode:
      name: display:mode
      title: Display Mode Change Broadcast
      summary: Broadcast when display mode changes
      description: |
        Broadcast display mode changes to all GM Scanners and admin clients.

        **Phase 4.2**: HDMI Display Control state machine

        **Display Modes**:
        - IDLE_LOOP: VLC plays idle-loop.mp4 on continuous loop
        - SCOREBOARD: Browser displays scoreboard.html in kiosk mode
        - VIDEO: VLC plays triggered video, returns to previous mode after

        **When Sent**:
        - GM sends display:idle-loop command → broadcast IDLE_LOOP
        - GM sends display:scoreboard command → broadcast SCOREBOARD
        - GM sends display:toggle command → broadcast new mode
        - Video starts playing → broadcast VIDEO
        - Video completes → broadcast return to previous mode

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: display:mode
            description: Event name
          data:
            type: object
            required:
              - mode
            properties:
              mode:
                type: string
                enum: [IDLE_LOOP, SCOREBOARD, VIDEO]
                description: Current display mode
                example: "SCOREBOARD"
              changedBy:
                type: string
                nullable: true
                description: Device ID that triggered the change
                example: "GM_STATION_1"
              video:
                type: string
                nullable: true
                description: Video filename if mode is VIDEO
                example: "intro.mp4"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:45.000Z"
      examples:
        - name: Switch to Scoreboard
          payload:
            event: display:mode
            data:
              mode: SCOREBOARD
              changedBy: GM_STATION_1
            timestamp: "2025-10-15T20:15:45.000Z"
        - name: Video Playing
          payload:
            event: display:mode
            data:
              mode: VIDEO
              changedBy: GM_STATION_1
              video: "intro.mp4"
            timestamp: "2025-10-15T20:16:00.000Z"

    DisplayStatus:
      name: display:status
      title: Display Status Response
      summary: Response to display:status command
      description: |
        Response sent to requesting client with current display status.

        **Phase 4.2**: HDMI Display Control state machine

        **Note**: This is a point-to-point response to the requesting socket,
        NOT a broadcast to all clients.

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: display:status
            description: Event name
          data:
            type: object
            required:
              - currentMode
              - previousMode
              - timestamp
            properties:
              currentMode:
                type: string
                enum: [IDLE_LOOP, SCOREBOARD, VIDEO]
                description: Current display mode
                example: "IDLE_LOOP"
              previousMode:
                type: string
                enum: [IDLE_LOOP, SCOREBOARD, VIDEO]
                description: Previous display mode (returned to after VIDEO)
                example: "IDLE_LOOP"
              pendingVideo:
                type: string
                nullable: true
                description: Currently playing video filename
                example: null
              timestamp:
                type: string
                format: date-time
                description: Status timestamp
                example: "2025-10-15T20:15:45.000Z"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:45.000Z"
      examples:
        - name: Idle Loop Status
          payload:
            event: display:status
            data:
              currentMode: IDLE_LOOP
              previousMode: IDLE_LOOP
              pendingVideo: null
              timestamp: "2025-10-15T20:15:45.000Z"
            timestamp: "2025-10-15T20:15:45.000Z"

    # ============================================================================
    # ENVIRONMENT CONTROL (6 events)
    # Phase 0: Bluetooth speaker management, audio routing, lighting scenes
    # ============================================================================

    BluetoothDevice:
      name: bluetooth:device
      title: Bluetooth Device State Change
      summary: Broadcast Bluetooth device state changes
      description: |
        Broadcast Bluetooth device state changes to all GM Scanners.

        **Phase 0**: Environment Control - Bluetooth speaker management

        **When Sent**:
        - Device discovered during scan (type: discovered)
        - Device paired via bluetoothctl (type: paired)
        - Device unpaired via bluetoothctl (type: unpaired)
        - Device connected (type: connected)
        - Device disconnected (type: disconnected)

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: bluetooth:device
            description: Event name
          data:
            type: object
            required:
              - type
              - device
            properties:
              type:
                type: string
                enum: [connected, disconnected, paired, unpaired, discovered]
                description: Device state change type
                example: "connected"
              device:
                type: object
                required:
                  - address
                  - name
                properties:
                  address:
                    type: string
                    description: Bluetooth MAC address
                    example: "AA:BB:CC:DD:EE:FF"
                  name:
                    type: string
                    description: Bluetooth device name
                    example: "Beats Pill"
                  connected:
                    type: boolean
                    description: >-
                      Whether device is currently connected.
                      Implementations SHOULD always include this field.
                    example: true
                  paired:
                    type: boolean
                    description: >-
                      Whether device is currently paired.
                      Implementations SHOULD always include this field.
                    example: true
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:05:00.000Z"
      examples:
        - name: Speaker Connected
          payload:
            event: bluetooth:device
            data:
              type: connected
              device:
                address: "AA:BB:CC:DD:EE:FF"
                name: "Beats Pill"
                connected: true
                paired: true
            timestamp: "2025-10-15T19:05:00.000Z"
        - name: Device Discovered During Scan
          payload:
            event: bluetooth:device
            data:
              type: discovered
              device:
                address: "11:22:33:44:55:66"
                name: "W-King X10"
                connected: false
                paired: false
            timestamp: "2025-10-15T19:05:02.000Z"

    BluetoothScan:
      name: bluetooth:scan
      title: Bluetooth Scan Status
      summary: Broadcast Bluetooth scan state and results
      description: |
        Broadcast Bluetooth scan status to all GM Scanners.

        **Phase 0**: Environment Control - Bluetooth device discovery

        **When Sent**:
        - Scan starts (scanning: true, no devices yet)
        - Scan completes (scanning: false, with final device snapshot)

        **Note**: Individual device discoveries during scan are sent via
        bluetooth:device events with type=discovered for real-time UI updates.
        The `devices` array on scan complete provides a final snapshot of all
        discovered devices — implementations SHOULD populate it via
        `bluetoothService.getDiscoveredDevices()` so the GM Scanner has a
        complete list without needing to accumulate individual discoveries.

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: bluetooth:scan
            description: Event name
          data:
            type: object
            required:
              - scanning
            properties:
              scanning:
                type: boolean
                description: Whether a scan is currently in progress
                example: false
              devices:
                type: array
                description: >-
                  Final snapshot of all discovered devices. Present when
                  scanning=false. Populated via getDiscoveredDevices().
                items:
                  type: object
                  required:
                    - address
                    - name
                  properties:
                    address:
                      type: string
                      description: Bluetooth MAC address
                      example: "AA:BB:CC:DD:EE:FF"
                    name:
                      type: string
                      description: Bluetooth device name
                      example: "Beats Pill"
                    rssi:
                      type: integer
                      description: Signal strength (dBm, optional)
                      example: -45
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:05:15.000Z"
      examples:
        - name: Scan Started
          payload:
            event: bluetooth:scan
            data:
              scanning: true
            timestamp: "2025-10-15T19:05:00.000Z"
        - name: Scan Complete
          payload:
            event: bluetooth:scan
            data:
              scanning: false
              devices:
                - address: "AA:BB:CC:DD:EE:FF"
                  name: "Beats Pill"
                  rssi: -45
                - address: "11:22:33:44:55:66"
                  name: "W-King X10"
                  rssi: -62
            timestamp: "2025-10-15T19:05:15.000Z"

    AudioRouting:
      name: audio:routing
      title: Audio Routing Change Broadcast
      summary: Broadcast audio routing changes
      description: |
        Broadcast audio routing changes to all GM Scanners.

        **Phase 0**: Environment Control - Audio output routing via PipeWire/pactl

        **Streams-and-Sinks Model**: Audio routing uses a per-stream routing table.
        Phase 0 only routes the `video` stream. Future phases add ambient, cue, and
        attention streams.

        **When Sent**:
        - GM sets audio route via audio:route:set command
        - Bluetooth speaker connects and routing auto-applies
        - Routing restored from persistence on startup

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: audio:routing
            description: Event name
          data:
            type: object
            required:
              - stream
              - sink
              - sinkType
            properties:
              stream:
                type: string
                description: Audio stream name (Phase 0 only uses 'video')
                example: "video"
              sink:
                type: string
                description: PipeWire sink name or identifier
                example: "bluez_output.AA_BB_CC_DD_EE_FF.1"
              sinkType:
                type: string
                enum: [hdmi, bluetooth, other]
                description: Sink type category for UI display
                example: "bluetooth"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:06:00.000Z"
      examples:
        - name: Route Video to Bluetooth Speaker
          payload:
            event: audio:routing
            data:
              stream: video
              sink: "bluez_output.AA_BB_CC_DD_EE_FF.1"
              sinkType: bluetooth
            timestamp: "2025-10-15T19:06:00.000Z"
        - name: Route Video to HDMI
          payload:
            event: audio:routing
            data:
              stream: video
              sink: "alsa_output.platform-fef00700.hdmi.hdmi-stereo"
              sinkType: hdmi
            timestamp: "2025-10-15T19:06:00.000Z"

    AudioRoutingFallback:
      name: audio:routing:fallback
      title: Audio Routing Fallback Notification
      summary: Broadcast when audio routing falls back to a different sink
      description: |
        Broadcast audio routing fallback to all GM Scanners when the preferred
        sink is unavailable and routing falls back to an alternative.

        **Phase 0**: Environment Control - Audio routing resilience

        **When Sent**:
        - Bluetooth speaker disconnects during playback -> fallback to HDMI
        - Preferred sink not found at routing time -> fallback to default

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: audio:routing:fallback
            description: Event name
          data:
            type: object
            required:
              - stream
              - reason
              - from
              - to
            properties:
              stream:
                type: string
                description: Audio stream that was rerouted
                example: "video"
              reason:
                type: string
                description: Reason for fallback
                example: "Bluetooth speaker disconnected"
              from:
                type: string
                description: Original sink that was unavailable
                example: "bluez_output.AA_BB_CC_DD_EE_FF.1"
              to:
                type: string
                description: Fallback sink used instead
                example: "alsa_output.platform-fef00700.hdmi.hdmi-stereo"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:30:00.000Z"
      examples:
        - name: Bluetooth Speaker Lost
          payload:
            event: audio:routing:fallback
            data:
              stream: video
              reason: "Bluetooth speaker disconnected"
              from: "bluez_output.AA_BB_CC_DD_EE_FF.1"
              to: "alsa_output.platform-fef00700.hdmi.hdmi-stereo"
            timestamp: "2025-10-15T20:30:00.000Z"

    LightingScene:
      name: lighting:scene
      title: Lighting Scene Activated Broadcast
      summary: Broadcast when a lighting scene is activated
      description: |
        Broadcast lighting scene activation to all GM Scanners.

        **Phase 0**: Environment Control - Home Assistant lighting scene control

        **When Sent**:
        - GM activates a scene via lighting:scene:activate command
        - Scene activated successfully via Home Assistant REST API

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: lighting:scene
            description: Event name
          data:
            type: object
            required:
              - sceneId
            properties:
              sceneId:
                type: string
                description: Home Assistant scene entity ID
                example: "scene.interrogation_red"
              sceneName:
                type: string
                description: Human-friendly scene name (from HA attributes)
                example: "Interrogation Red"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:30:00.000Z"
      examples:
        - name: Scene Activated
          payload:
            event: lighting:scene
            data:
              sceneId: "scene.interrogation_red"
              sceneName: "Interrogation Red"
            timestamp: "2025-10-15T19:30:00.000Z"

    LightingStatus:
      name: lighting:status
      title: Lighting Service Status
      summary: Broadcast Home Assistant connection status
      description: |
        Broadcast Home Assistant connection status to all GM Scanners.

        **Phase 0**: Environment Control - Home Assistant connectivity

        **When Sent**:
        - On initial connection to Home Assistant
        - On Home Assistant connection loss
        - On Home Assistant reconnection
        - After lighting:scenes:refresh command completes

        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: lighting:status
            description: Event name
          data:
            type: object
            required:
              - connected
            properties:
              connected:
                type: boolean
                description: Whether Home Assistant is reachable
                example: true
              sceneCount:
                type: integer
                description: Number of available scenes (present when connected)
                minimum: 0
                example: 6
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:00:05.000Z"
      examples:
        - name: Connected with Scenes
          payload:
            event: lighting:status
            data:
              connected: true
              sceneCount: 6
            timestamp: "2025-10-15T19:00:05.000Z"
        - name: Disconnected
          payload:
            event: lighting:status
            data:
              connected: false
            timestamp: "2025-10-15T20:45:00.000Z"

    # ============================================================================
    # SESSION MANAGEMENT (2 events)
    # ============================================================================

    SessionUpdate:
      name: session:update
      title: Session State Change Broadcast
      summary: Broadcast session state changes to all GMs
      description: |
        Broadcast session state changes (created/paused/resumed/ended) to all GMs.

        **Functional Requirement**: Section 1.2 (Session Management)
        **Decisions Applied**: #2 (wrapped envelope), #4 (id field), #7 (full resource)

        **CRITICAL - Decision #7**:
        Send FULL session resource (matches GET /api/session structure), not minimal delta.

        **Replaces**:
        - session:new (use status='active' with new session)
        - session:paused (use status='paused')
        - session:resumed (use status='active')
        - session:ended (use status='ended')

        **Breaking Changes**:
        - Field: sessionId → id (per Decision 4)
        - Structure: Full resource (per Decision 7)
        - Added: teams array
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: session:update
            description: Event name
          data:
            type: object
            required:
              - id
              - name
              - startTime
              - status
              - teams
              - metadata
            properties:
              id:
                type: string
                format: uuid
                description: Session ID (per Decision 4 - use 'id' within resource)
                example: "2a2f9d45-5d2d-441d-b32c-52c939f3c103"
              name:
                type: string
                description: Event name
                example: "About Last Night - Oct 15 2025"
              startTime:
                type: string
                format: date-time
                description: Session start time
                example: "2025-10-15T19:00:00.000Z"
              endTime:
                type: string
                format: date-time
                nullable: true
                description: Session end time (null if active)
                example: null
              status:
                type: string
                enum: [setup, active, paused, ended]
                description: Session status
                example: "active"
              teams:
                type: array
                items:
                  type: string
                  description: Array of team IDs
                example: ["Team Alpha", "Detectives", "Blue Squad"]
              metadata:
                type: object
                description: Session metadata
                example:
                  gmStations: 2
                  playerDevices: 3
                  totalScans: 47
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:00:00.100Z"

    SessionOvertime:
      name: session:overtime
      title: Session Overtime Warning
      summary: Notify GMs when session exceeds expected duration
      description: |
        Broadcast warning to GM stations when session runs longer than expected duration.
        **Does NOT automatically end the session** - only provides notification.

        **Functional Requirement**: Session length tracking and GM notification
        **Decisions Applied**: #2 (wrapped envelope)

        **Trigger**: Fires once when session duration exceeds SESSION_TIMEOUT config (default: 120 minutes)
        **Action**: GM stations can choose to end session manually via admin panel
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: session:overtime
            description: Event name
          data:
            type: object
            required:
              - sessionId
              - sessionName
              - startTime
              - expectedDuration
              - actualDuration
              - overtimeDuration
            properties:
              sessionId:
                type: string
                format: uuid
                description: Session ID
                example: "2a2f9d45-5d2d-441d-b32c-52c939f3c103"
              sessionName:
                type: string
                description: Session name
                example: "About Last Night - Oct 15 2025"
              startTime:
                type: string
                format: date-time
                description: Session start time
                example: "2025-10-15T19:00:00.000Z"
              expectedDuration:
                type: integer
                description: Expected session duration in minutes
                example: 120
              actualDuration:
                type: integer
                description: Actual session duration in minutes when warning triggered
                example: 120
              overtimeDuration:
                type: integer
                description: Minutes over expected duration
                example: 0
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T21:00:00.000Z"

    # ============================================================================
    # ADMIN COMMANDS (2 events)
    # ============================================================================

    GmCommand:
      name: gm:command
      title: Admin Control Commands
      summary: Admin Panel sends control commands
      description: |
        Unified command interface for ALL admin operations.

        **Functional Requirement**: Section 4.2 (Admin Panel Intervention Functions)
        **Decisions Applied**: #2 (wrapped envelope)

        **CRITICAL**: This SINGLE event replaces 11 HTTP admin endpoints (architectural confusion fixed).

        **Command Actions**:
        - Session: create, pause, resume, end
        - Video: play, pause, stop, skip, queue:add, queue:reorder, queue:clear
        - Display: idle-loop, scoreboard, toggle, status
        - Score: adjust
        - Transaction: delete, create
        - System: reset
        - Bluetooth: scan:start, scan:stop, pair, unpair, connect, disconnect
        - Audio: route:set
        - Lighting: scene:activate, scenes:refresh

        **Environment Control Action Payloads (Phase 0)**:
        - `bluetooth:scan:start` — `{timeout?: integer}` (default 15s)
        - `bluetooth:scan:stop` — `{}`
        - `bluetooth:pair` — `{address: string}` (required)
        - `bluetooth:unpair` — `{address: string}` (required)
        - `bluetooth:connect` — `{address: string}` (required)
        - `bluetooth:disconnect` — `{address: string}` (required)
        - `audio:route:set` — `{stream: 'video', sink: 'hdmi'|'bluetooth'}` (Phase 0 only accepts stream='video').
          The GM sends a logical alias ('hdmi'/'bluetooth'); audioRoutingService resolves
          it to an actual PipeWire sink name. The `audio:routing` broadcast reports the
          resolved sink name with a `sinkType` field for the UI-friendly category.
        - `lighting:scene:activate` — `{sceneId: string}` (required, HA entity ID)
        - `lighting:scenes:refresh` — `{}`

        **Breaking Changes**: Admin commands moved from HTTP POST to WebSocket (proper transport).
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: gm:command
            description: Event name
          data:
            type: object
            required:
              - action
              - payload
            properties:
              action:
                type: string
                description: Command action type
                enum:
                  - session:create
                  - session:addTeam
                  - session:pause
                  - session:resume
                  - session:end
                  - session:start
                  - video:play
                  - video:pause
                  - video:stop
                  - video:skip
                  - video:queue:add
                  - video:queue:reorder
                  - video:queue:clear
                  - display:idle-loop
                  - display:scoreboard
                  - display:toggle
                  - display:status
                  - score:adjust
                  - score:reset
                  - transaction:delete
                  - transaction:create
                  - system:reset
                  - bluetooth:scan:start
                  - bluetooth:scan:stop
                  - bluetooth:pair
                  - bluetooth:unpair
                  - bluetooth:connect
                  - bluetooth:disconnect
                  - audio:route:set
                  - audio:volume:set
                  - lighting:scene:activate
                  - lighting:scenes:refresh
                  - cue:fire
                  - cue:stop
                  - cue:pause
                  - cue:resume
                  - cue:enable
                  - cue:disable
                  - cue:conflict:resolve
                  - sound:play
                  - sound:stop
                  - spotify:play
                  - spotify:pause
                  - spotify:stop
                  - spotify:next
                  - spotify:previous
                  - spotify:volume
                  - spotify:playlist
                example: "video:skip"
              payload:
                type: object
                description: Action-specific parameters
                example: {}
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:20:00.000Z"
      examples:
        - name: Session Create
          payload:
            event: gm:command
            data:
              action: session:create
              payload:
                name: "About Last Night - Oct 15 2025"
                teams: ["Team Alpha", "Detectives", "Blue Squad"]
            timestamp: "2025-10-15T19:00:00.000Z"
        - name: Video Skip
          payload:
            event: gm:command
            data:
              action: video:skip
              payload: {}
            timestamp: "2025-10-15T20:20:00.000Z"
        - name: Score Adjust
          payload:
            event: gm:command
            data:
              action: score:adjust
              payload:
                teamId: "Team Alpha"
                delta: -500
                reason: "Penalty for rule violation"
            timestamp: "2025-10-15T20:25:00.000Z"
        - name: Bluetooth Scan Start
          payload:
            event: gm:command
            data:
              action: bluetooth:scan:start
              payload:
                timeout: 15
            timestamp: "2025-10-15T19:05:00.000Z"
        - name: Bluetooth Connect
          payload:
            event: gm:command
            data:
              action: bluetooth:connect
              payload:
                address: "AA:BB:CC:DD:EE:FF"
            timestamp: "2025-10-15T19:05:30.000Z"
        - name: Audio Route Set
          payload:
            event: gm:command
            data:
              action: audio:route:set
              payload:
                stream: video
                sink: bluetooth
            timestamp: "2025-10-15T19:06:00.000Z"
        - name: Lighting Scene Activate
          payload:
            event: gm:command
            data:
              action: lighting:scene:activate
              payload:
                sceneId: "scene.interrogation_red"
            timestamp: "2025-10-15T19:30:00.000Z"
        - name: Lighting Scenes Refresh
          payload:
            event: gm:command
            data:
              action: lighting:scenes:refresh
              payload: {}
            timestamp: "2025-10-15T19:00:10.000Z"

    GmCommandAck:
      name: gm:command:ack
      title: Command Acknowledgment
      summary: Server acknowledges command execution
      description: |
        Server sends command acknowledgment to command sender only.

        **Functional Requirement**: Section 4.2 (Admin Panel command feedback)
        **Decisions Applied**: #2 (wrapped envelope)

        **Flow**:
        1. Admin sends gm:command
        2. Server executes command
        3. Server sends gm:command:ack to sender (success/failure)
        4. Server broadcasts side effects (e.g., video:status, score:updated)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: gm:command:ack
            description: Event name
          data:
            type: object
            required:
              - action
              - success
              - message
            properties:
              action:
                type: string
                description: Original command action
                example: "video:skip"
              success:
                type: boolean
                description: Command execution success
                example: true
              message:
                type: string
                description: Result message
                example: "Video skipped successfully"
              error:
                type: string
                nullable: true
                description: Error code if failed
                example: null
              result:
                type: object
                nullable: true
                description: Action-specific result data
                example: null
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:20:00.100Z"

    # ============================================================================
    # OFFLINE QUEUE (1 event)
    # ============================================================================

    OfflineQueueProcessed:
      name: offline:queue:processed
      title: Offline Queue Processing Complete
      summary: Notify clients when offline queue processed
      description: |
        Broadcast when offline queue has been processed (after reconnection).

        **Functional Requirement**: Section 1.8 (Offline Queue Management)
        **Decisions Applied**: #2 (wrapped envelope)

        **Flow**:
        1. Player Scanner reconnects after offline period
        2. Uploads queued scans via HTTP POST /api/scan/batch
        3. Server processes batch
        4. Server broadcasts offline:queue:processed
        5. Server broadcasts sync:full with updated state
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: offline:queue:processed
            description: Event name
          data:
            type: object
            required:
              - queueSize
              - results
            properties:
              queueSize:
                type: integer
                description: Number of items processed
                example: 5
              results:
                type: array
                description: Per-item results
                items:
                  type: object
                  required:
                    - transactionId
                    - status
                  properties:
                    transactionId:
                      type: string
                      format: uuid
                      description: Generated transaction ID
                      example: "7b8b1d85-b234-4be9-bde5-4c8522a1f15e"
                    status:
                      type: string
                      enum: [processed, failed]
                      description: Processing status
                      example: "processed"
                    error:
                      type: string
                      nullable: true
                      description: Error message if failed
                      example: null
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:10:00.000Z"

    BatchAck:
      name: batch:ack
      title: Batch Upload Acknowledgment
      summary: Acknowledge successful batch processing
      description: |
        Server confirms batch upload processed successfully. Sent to specific device after POST /api/scan/batch.

        **Phase 1.2 (P0.2)**: Offline Queue Acknowledgment
        - Prevents data loss on network failures
        - Client waits for ACK before clearing queue
        - Idempotency via batchId prevents double-processing

        **Flow**:
        1. GM Scanner uploads batch via POST /api/scan/batch with batchId
        2. Server processes all transactions in batch
        3. Server emits batch:ack to device room (device:${deviceId})
        4. GM Scanner receives ACK, clears queue
        5. If ACK timeout (60s), queue preserved for retry

        **Idempotency**: Server caches results by batchId for 1 hour.
        Retry with same batchId returns cached result without reprocessing.

        **Functional Requirement**: Section 1.8 (Offline Queue Management)
        **Decisions Applied**: #2 (wrapped envelope)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: batch:ack
            description: Event name
          data:
            type: object
            required:
              - batchId
              - processedCount
              - totalCount
              - failedCount
              - failures
            properties:
              batchId:
                type: string
                format: uuid
                description: Unique batch identifier for idempotency
                example: "a3f4b2c1-5678-90ab-cdef-1234567890ab"
              processedCount:
                type: integer
                description: Number of successfully processed transactions
                example: 8
              totalCount:
                type: integer
                description: Total number of transactions in batch
                example: 10
              failedCount:
                type: integer
                description: Number of failed transactions
                example: 2
              failures:
                type: array
                description: Details of failed transactions
                items:
                  type: object
                  required:
                    - index
                    - tokenId
                    - error
                  properties:
                    index:
                      type: integer
                      description: Index in original batch array
                      example: 3
                    tokenId:
                      type: string
                      description: Token ID that failed
                      example: "kaa001"
                    error:
                      type: string
                      description: Error message
                      example: "Token not recognized"
                example: []
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:10:05.000Z"

    # ============================================================================
    # GROUP COMPLETION (1 event)
    # ============================================================================

    GroupCompleted:
      name: group:completed
      title: Group Completion Bonus Broadcast
      summary: Broadcast when team completes token group
      description: |
        Broadcast when team completes token group (bonus points awarded).

        **Functional Requirement**: Section 1.3.6 (Transaction Processing - Group Completion)
        **Decisions Applied**: #2 (wrapped envelope)

        **Note**: Important game event (group completions are major scoring moments).
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: group:completed
            description: Event name
          data:
            type: object
            required:
              - teamId
              - group
              - bonusPoints
              - completedAt
            properties:
              teamId:
                type: string
                description: Team ID
                example: "Team Alpha"
              group:
                type: string
                description: Group name/ID
                example: "jaw_group"
              bonusPoints:
                type: integer
                description: Bonus points awarded
                example: 500
              completedAt:
                type: string
                format: date-time
                description: Completion timestamp
                example: "2025-10-15T20:15:30.000Z"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:30.100Z"

    # ============================================================================
    # PLAYER SCANNER MONITORING (1 event)
    # ============================================================================

    PlayerScan:
      name: player:scan
      title: Player Scanner Scan Event
      summary: Broadcast player scanner scan events to GM scanners for game activity tracking
      description: |
        Broadcast player scanner scan events to GM scanner admin panels.

        **Purpose**: Enable GM admin panel to track token discoveries (Game Activity feature)
        **Audience**: gm room (GM scanners ARE the admin panels)
        **Source**: HTTP POST /api/scan endpoint → sessionService.addPlayerScan()

        This event is emitted for ALL player scanner token scans (video, image, audio).
        Player scans are now PERSISTED to session for:
        - Game Activity tracking (tokens in play)
        - Restart persistence (sync:full includes playerScans)
        - Token lifecycle observability (discovered → claimed)

        **Architecture Change (2025-12)**:
        - Player scans now persist to session.playerScans[]
        - Broadcast moved from admin-monitors to gm room
        - Added scanId for correlation with persisted record
        - Added tokenData for token metadata

        **Key Fields**:
        - scanId: UUID of persisted scan record (for correlation)
        - tokenId: Token scanned by player
        - deviceId: Player scanner device ID
        - videoQueued: True if token has video property (queued for TV playback)
        - memoryType: Token type from token data (Personal, Business, etc.)
        - tokenData: Full token metadata for display
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: player:scan
            description: Event name
          data:
            type: object
            required:
              - scanId
              - tokenId
              - deviceId
              - timestamp
            properties:
              scanId:
                type: string
                format: uuid
                description: UUID of persisted player scan record
                example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
              tokenId:
                type: string
                description: Token ID that was scanned
                example: "sof002"
              deviceId:
                type: string
                description: Player scanner device ID
                example: "PLAYER_8a7b9c1d"
              videoQueued:
                type: boolean
                description: True if token has video property and was queued for TV playback
                example: false
              memoryType:
                type: string
                nullable: true
                description: Token type from token data (Personal, Business, Technical, etc.)
                example: "Personal"
              tokenData:
                type: object
                nullable: true
                description: Full token metadata for display
                properties:
                  SF_MemoryType:
                    type: string
                    nullable: true
                    example: "Personal"
                  SF_ValueRating:
                    type: integer
                    nullable: true
                    minimum: 1
                    maximum: 5
                    example: 3
                  SF_Group:
                    type: string
                    nullable: true
                    example: "Server Logs (x5)"
                  summary:
                    type: string
                    nullable: true
                    example: "Encrypted server logs revealing unauthorized access"
              timestamp:
                type: string
                format: date-time
                description: Scan timestamp
                example: "2025-10-29T10:15:30.000Z"
          timestamp:
            type: string
            format: date-time
            description: Event broadcast timestamp
            example: "2025-10-29T10:15:30.100Z"

    # ============================================================================
    # ERRORS (1 event)
    # ============================================================================

    Error:
      name: error
      title: Error Notification
      summary: Send error notifications to clients
      description: |
        Send error notifications to clients for user-facing display.

        **Functional Requirement**: Section 5 (Error Handling), Decision 10
        **Decisions Applied**: #2 (wrapped envelope), #10 (error display)

        **CRITICAL - Decision #10**:
        User-facing errors (no more console-only errors).
        Clients MUST display error messages to users.
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: error
            description: Event name
          data:
            type: object
            required:
              - code
              - message
            properties:
              code:
                type: string
                description: Error code
                enum:
                  - AUTH_REQUIRED
                  - AUTH_INVALID
                  - DEVICE_ID_COLLISION
                  - PERMISSION_DENIED
                  - VALIDATION_ERROR
                  - SESSION_NOT_FOUND
                  - TOKEN_NOT_FOUND
                  - DUPLICATE_TRANSACTION
                  - INVALID_REQUEST
                  - VLC_ERROR
                  - INTERNAL_ERROR
                example: "TOKEN_NOT_FOUND"
              message:
                type: string
                description: User-friendly error message
                example: "Token not found in database"
              details:
                type: object
                nullable: true
                description: Optional error details
                example: null
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:15:30.100Z"

    # ============================================================================
    # PHASE 1: GAME CLOCK, CUE ENGINE, AND SOUND (6 events)
    # ============================================================================

    GameClockStatus:
      name: gameclock:status
      title: Game Clock Status
      summary: Broadcast game clock state changes
      description: |
        Broadcast when game clock state changes (running, paused, stopped).

        **Phase 1 Feature**: Game clock provides centralized time tracking for the 2-hour game session.

        **State Transitions**:
        - stopped → running (session starts)
        - running → paused (session paused)
        - paused → running (session resumed)
        - running → stopped (session ended)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: gameclock:status
            description: Event name
          data:
            type: object
            required:
              - state
              - elapsed
            properties:
              state:
                type: string
                description: Current game clock state
                enum:
                  - running
                  - paused
                  - stopped
                example: "running"
              elapsed:
                type: integer
                description: Elapsed time in seconds
                example: 3600
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:00:00.000Z"

    CueFired:
      name: cue:fired
      title: Cue Fired Event
      summary: Broadcast when a cue is fired
      description: |
        Broadcast when a cue sequence is triggered and begins execution.

        **Phase 1 Feature**: Cue engine automates game actions (sound, lighting, video) based on triggers.

        **Triggers**:
        - Manual: GM fires cue via gm:command (source: 'gm')
        - Automatic: Event-based trigger (e.g., transaction:accepted, source: 'cue')
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: cue:fired
            description: Event name
          data:
            type: object
            required:
              - cueId
              - trigger
              - source
            properties:
              cueId:
                type: string
                description: Unique cue identifier
                example: "business-sale"
              trigger:
                type: string
                description: What triggered this cue
                example: "event:transaction:accepted"
              source:
                type: string
                description: Source of the trigger
                enum:
                  - gm
                  - cue
                example: "cue"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:10:00.000Z"

    CueStatus:
      name: cue:status
      title: Cue Status Update (Phase 2)
      summary: Compound cue progress update
      description: |
        Broadcast when a compound cue's state or progress changes during execution.

        **Phase 2 Enhancement**: Added progress tracking for compound cues with timelines.

        **States**:
        - started: Cue just began execution
        - running: Cue is actively executing actions
        - paused: Cue execution paused (manual intervention)
        - completed: Cue finished all actions successfully
        - stopped: Cue manually stopped before completion
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: cue:status
            description: Event name
          data:
            type: object
            required:
              - cueId
              - state
            properties:
              cueId:
                type: string
                description: Unique cue identifier
                example: "interrogation-scene-1"
              state:
                type: string
                description: Current cue state
                enum:
                  - started
                  - running
                  - paused
                  - completed
                  - stopped
                example: "running"
              progress:
                type: number
                description: Elapsed seconds into timeline (Phase 2)
                example: 45.5
              duration:
                type: number
                description: Total timeline duration in seconds (Phase 2)
                example: 120
              hasVideo:
                type: boolean
                description: Whether this cue includes video playback (Phase 2)
                example: true
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:00:05.000Z"

    CueCompleted:
      name: cue:completed
      title: Cue Completed Event
      summary: Broadcast when a cue completes successfully
      description: |
        Broadcast when a cue finishes executing all actions successfully.

        **Note**: This is a terminal state - the cue will not execute further unless re-fired.
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: cue:completed
            description: Event name
          data:
            type: object
            required:
              - cueId
            properties:
              cueId:
                type: string
                description: Unique cue identifier
                example: "first-scan-fanfare"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:05:00.000Z"

    CueError:
      name: cue:error
      title: Cue Error Event
      summary: Broadcast when a cue action fails
      description: |
        Broadcast when a cue encounters an error during action execution.

        **Error Handling**: Cue engine continues to next action after error (fail-fast per action, not per cue).

        **Common Errors**:
        - pw-play not found (PipeWire command missing)
        - File not found (audio/video asset missing)
        - Home Assistant unreachable (lighting service unavailable)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: cue:error
            description: Event name
          data:
            type: object
            required:
              - cueId
              - action
              - position
              - error
            properties:
              cueId:
                type: string
                description: Unique cue identifier
                example: "business-sale"
              action:
                type: string
                description: Action that failed
                example: "sound:play"
              position:
                type: integer
                nullable: true
                description: Action position in cue sequence (null if not applicable)
                example: null
              error:
                type: string
                description: Error message
                example: "pw-play not found"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:12:00.000Z"

    CueConflict:
      name: cue:conflict
      title: Video Conflict Prompt (Phase 2)
      summary: Video conflict prompt for GM decision
      description: |
        Broadcast when a compound cue attempts to play video while another video is active.

        **Phase 2 Feature**: GM must decide whether to interrupt current video or cancel cue.

        **Auto-Cancel Behavior**: If GM doesn't respond within autoCancelMs, cue automatically cancels.

        **GM Response**: GM sends gm:command with action=cue:conflict:resolve and payload={cueId, decision: 'interrupt'|'cancel'}
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: cue:conflict
            description: Event name
          data:
            type: object
            required:
              - cueId
              - reason
              - currentVideo
            properties:
              cueId:
                type: string
                description: Cue ID requesting video playback
                example: "interrogation-scene-2"
              reason:
                type: string
                description: Conflict reason
                example: "Video already playing"
              currentVideo:
                type: string
                description: Currently playing video filename
                example: "test_30sec.mp4"
              autoCancel:
                type: boolean
                description: Whether cue will auto-cancel on timeout
                default: true
                example: true
              autoCancelMs:
                type: number
                description: Auto-cancel timeout in milliseconds
                default: 10000
                example: 10000
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T20:12:00.000Z"

    SoundStatus:
      name: sound:status
      title: Sound Status Event
      summary: Broadcast currently playing sounds
      description: |
        Broadcast current sound playback state.

        **Phase 1 Feature**: Sound service plays audio via PipeWire (pw-play) to specific targets.

        **Targets**:
        - combine-bt: Combined Bluetooth speaker output
        - hdmi: HDMI audio output
        - (other PipeWire sink names)
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: sound:status
            description: Event name
          data:
            type: object
            required:
              - playing
            properties:
              playing:
                type: array
                description: Currently playing sounds
                items:
                  type: object
                  required:
                    - file
                    - target
                  properties:
                    file:
                      type: string
                      description: Audio file name
                      example: "fanfare.wav"
                    target:
                      type: string
                      description: PipeWire sink target
                      example: "combine-bt"
                example:
                  - file: "fanfare.wav"
                    target: "combine-bt"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:05:01.000Z"

    SpotifyStatus:
      name: spotify:status
      title: Spotify Playback Status (Phase 2)
      summary: Spotify playback state broadcast
      description: |
        Broadcast Spotify playback state changes.

        **Phase 2 Feature**: Spotify integration for background music during gameplay.

        **States**:
        - playing: Spotify is actively playing
        - paused: Playback paused
        - stopped: Playback stopped

        **Cache Status**:
        - verified: Playlist cached and available offline
        - missing: Playlist not cached
        - unchecked: Cache status not yet verified
      payload:
        type: object
        required:
          - event
          - data
          - timestamp
        properties:
          event:
            type: string
            const: spotify:status
            description: Event name
          data:
            type: object
            required:
              - connected
              - state
            properties:
              connected:
                type: boolean
                description: Whether Spotify is connected
                example: true
              state:
                type: string
                description: Current playback state
                enum:
                  - playing
                  - paused
                  - stopped
                example: "playing"
              track:
                type: object
                description: Currently playing track (optional)
                properties:
                  title:
                    type: string
                    description: Track title
                    example: "Nocturne in E-flat major"
                  artist:
                    type: string
                    description: Artist name
                    example: "Chopin"
              volume:
                type: number
                description: Current volume (0-100)
                minimum: 0
                maximum: 100
                example: 75
              playlist:
                type: string
                description: Current playlist name
                example: "Interrogation Ambience"
              cacheStatus:
                type: string
                description: Offline cache status
                enum:
                  - verified
                  - missing
                  - unchecked
                example: "verified"
          timestamp:
            type: string
            format: date-time
            description: Event timestamp
            example: "2025-10-15T19:05:01.000Z"
