# Phase 1.3: Show Summary in All Modes - Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Show token summary (intel) on result screen for all transaction modes, not just detective mode.

**Architecture:** Remove mode check from `showResult()`, clean up dead code (`renderTransactions`, `filterTransactions`), update tests.

**Tech Stack:** ES6 modules, Jest, Vite

---

## Task 1: Fix Result Screen Summary Display

**Files:**
- Modify: `ALNScanner/src/ui/uiManager.js:821`
- Test: `ALNScanner/tests/unit/ui/uiManager.test.js`

**Step 1: Write the failing test**

Add to `ALNScanner/tests/unit/ui/uiManager.test.js` in the UIManager describe block:

```javascript
describe('showResult - summary display', () => {
  beforeEach(() => {
    document.body.innerHTML = `
      <div id="resultStatus" class="status-message"></div>
      <div id="resultRfid"></div>
      <div id="resultType"></div>
      <div id="resultGroup"></div>
      <div id="resultValue"></div>
      <div id="resultSummaryContainer" style="display: none;"></div>
      <p id="resultSummary"></p>
      <div id="resultScreen" class="screen"></div>
    `;
  });

  it('should show summary in blackmarket mode when token has summary', () => {
    uiManager.settings = { mode: 'blackmarket' };

    const mockDataSource = {
      calculateTokenValue: jest.fn(() => 50000)
    };
    jest.spyOn(uiManager, '_getDataSource').mockReturnValue(mockDataSource);

    const token = {
      SF_MemoryType: 'Technical',
      SF_ValueRating: 3,
      SF_Group: 'Server Logs',
      summary: 'Encrypted server logs revealing unauthorized access'
    };

    uiManager.showResult('token123', token, false);

    const summaryContainer = document.getElementById('resultSummaryContainer');
    const summaryEl = document.getElementById('resultSummary');

    expect(summaryContainer.style.display).toBe('flex');
    expect(summaryEl.textContent).toBe('Encrypted server logs revealing unauthorized access');
  });

  it('should hide summary when token has no summary', () => {
    uiManager.settings = { mode: 'blackmarket' };

    const mockDataSource = {
      calculateTokenValue: jest.fn(() => 50000)
    };
    jest.spyOn(uiManager, '_getDataSource').mockReturnValue(mockDataSource);

    const token = {
      SF_MemoryType: 'Technical',
      SF_ValueRating: 3,
      SF_Group: 'Server Logs'
      // No summary field
    };

    uiManager.showResult('token123', token, false);

    const summaryContainer = document.getElementById('resultSummaryContainer');
    expect(summaryContainer.style.display).toBe('none');
  });
});
```

**Step 2: Run test to verify it fails**

Run: `cd ALNScanner && npm test -- tests/unit/ui/uiManager.test.js --testNamePattern="showResult - summary display"`

Expected: FAIL - "should show summary in blackmarket mode" fails because mode check prevents display

**Step 3: Fix the implementation**

In `ALNScanner/src/ui/uiManager.js`, change line 821 from:

```javascript
      // Show summary in detective mode if available
      if (this.settings.mode === 'detective' && token.summary && summaryContainer && summaryEl) {
```

To:

```javascript
      // Show summary if available (all modes - gives GM visibility on token content)
      if (token.summary && summaryContainer && summaryEl) {
```

**Step 4: Run test to verify it passes**

Run: `cd ALNScanner && npm test -- tests/unit/ui/uiManager.test.js --testNamePattern="showResult - summary display"`

Expected: PASS

**Step 5: Commit**

```bash
cd ALNScanner
git add src/ui/uiManager.js tests/unit/ui/uiManager.test.js
git commit -m "feat(scanner): show token summary in all modes on result screen

Previously summary was only shown in detective mode. Now GMs see
token intel regardless of transaction mode for better visibility.

Includes tests for blackmarket mode summary display."
```

---

## Task 2: Remove Dead Code - renderTransactions

**Files:**
- Modify: `ALNScanner/src/ui/uiManager.js:634-685` (remove)
- Modify: `ALNScanner/tests/unit/ui/uiManager.test.js` (remove tests)

**Step 1: Identify test lines to remove**

In `ALNScanner/tests/unit/ui/uiManager.test.js`, find and note tests for `renderTransactions`:
- Lines around 493-509 (renderTransactions tests)

**Step 2: Remove tests for renderTransactions**

Remove the entire describe block or individual tests for `renderTransactions`. Search for:
- `uiManager.renderTransactions()`
- Any test with "renderTransactions" in the name

**Step 3: Run tests to verify removal doesn't break anything**

Run: `cd ALNScanner && npm test -- tests/unit/ui/uiManager.test.js`

Expected: PASS (fewer tests, but all passing)

**Step 4: Remove renderTransactions from uiManager.js**

Remove lines 634-685 (the entire `renderTransactions` method):

```javascript
  /**
   * Render transaction history
   * @param {Array} filtered - Filtered transactions (optional)
   */
  renderTransactions(filtered = null) {
    // ... entire method body ...
  }
```

**Step 5: Run tests again**

Run: `cd ALNScanner && npm test -- tests/unit/ui/uiManager.test.js`

Expected: PASS

**Step 6: Commit**

```bash
cd ALNScanner
git add src/ui/uiManager.js tests/unit/ui/uiManager.test.js
git commit -m "refactor(scanner): remove dead renderTransactions method

This method was replaced by renderGameActivity which provides
richer token lifecycle view with summaries. The historyContainer
now uses renderGameActivity exclusively."
```

---

## Task 3: Remove Dead Code - filterTransactions

**Files:**
- Modify: `ALNScanner/src/ui/uiManager.js:690-717` (remove, line numbers shifted after Task 2)
- Modify: `ALNScanner/tests/unit/ui/uiManager.test.js` (remove tests)

**Step 1: Remove tests for filterTransactions**

In `ALNScanner/tests/unit/ui/uiManager.test.js`, remove tests containing:
- `uiManager.filterTransactions()`
- Any test with "filterTransactions" in the name

**Step 2: Run tests to verify removal doesn't break anything**

Run: `cd ALNScanner && npm test -- tests/unit/ui/uiManager.test.js`

Expected: PASS

**Step 3: Remove filterTransactions from uiManager.js**

After removing renderTransactions, find and remove the `filterTransactions` method (previously lines 690-717, now shifted):

```javascript
  /**
   * Filter transactions based on search criteria
   */
  filterTransactions() {
    // ... entire method body ...
  }
```

**Step 4: Run tests again**

Run: `cd ALNScanner && npm test -- tests/unit/ui/uiManager.test.js`

Expected: PASS

**Step 5: Commit**

```bash
cd ALNScanner
git add src/ui/uiManager.js tests/unit/ui/uiManager.test.js
git commit -m "refactor(scanner): remove dead filterTransactions method

This method was used by the old renderTransactions. Activity filtering
is now handled by renderGameActivity's own filter handlers."
```

---

## Task 4: Clean Up Mock References

**Files:**
- Modify: `ALNScanner/tests/unit/ui/ScreenUpdateManager.test.js`
- Modify: `ALNScanner/tests/app/app.test.js`

**Step 1: Update ScreenUpdateManager.test.js mocks**

Find and remove `renderTransactions` from the mock UIManager object (around line 24):

```javascript
// Remove this line from mockUIManager:
renderTransactions: jest.fn(),
```

Also update any test that references `mockUIManager.renderTransactions`.

**Step 2: Update app.test.js mocks**

Find and remove `renderTransactions` from the mock (around line 21):

```javascript
// Remove this line from mock:
renderTransactions: jest.fn(),
```

**Step 3: Run full test suite**

Run: `cd ALNScanner && npm test`

Expected: All tests pass (743 - removed tests)

**Step 4: Commit**

```bash
cd ALNScanner
git add tests/unit/ui/ScreenUpdateManager.test.js tests/app/app.test.js
git commit -m "test(scanner): remove renderTransactions mock references

Cleanup mock objects after removing dead code."
```

---

## Task 5: Final Verification

**Step 1: Run full ALNScanner test suite**

Run: `cd ALNScanner && npm test`

Expected: All tests pass

**Step 2: Build for production**

Run: `cd ALNScanner && npm run build`

Expected: Build succeeds

**Step 3: Run backend tests to ensure no cross-impact**

Run: `cd /home/maxepunk/projects/AboutLastNight/ALN-Ecosystem/backend && npm test`

Expected: 528/528 pass

**Step 4: Final commit if any cleanup needed**

If all passes, no commit needed. Otherwise fix and commit.

---

## Summary

| Task | Description | Lines Changed |
|------|-------------|---------------|
| 1 | Fix result screen summary | +30 test, ~1 source |
| 2 | Remove renderTransactions | -52 source, -20 test |
| 3 | Remove filterTransactions | -28 source, -15 test |
| 4 | Clean up mock references | -5 test |
| 5 | Final verification | 0 |

**Net change:** ~-90 lines (dead code removal)
