# Task 3.2 Deep Investigation: UIManager Test Failures

**Date:** October 30, 2025
**Investigator:** Claude Code (executing-plans skill + testing-anti-patterns skill)
**Status:** Investigation Complete - Plan Update Required
**Original Plan:** `docs/plans/2025-10-30-fix-test-failures-comprehensive.md` lines 1348-1498

---

## Executive Summary

**Original Plan Assumption:** "Scanner UI tests test browser code in Node" → Fix by adding jsdom

**Reality After Investigation:** Root cause is **dual-layer failure**:
1. **Primary (12/14 failures):** October 2025 field standardization not applied to tests (`stationMode` → `mode`)
2. **Secondary (2/14 failures + design issue):** Tests assert on mock DOM properties (Anti-Pattern #1)

**Recommendation:** **Revise Task 3.2 completely** - jsdom alone won't fix the root causes.

---

## Investigation Findings

### Finding 1: October 2025 Field Standardization Incomplete

**Context:** Per CLAUDE.md lines 44-48, October 2025 removed `stationMode` alias:
```
### October 2025: Field Standardization
- Removed `ConnectionManager.stationMode` alias property
- Use `ConnectionManager.mode` exclusively
- localStorage key name unchanged ('stationMode')
```

**Implementation:** UIManager uses `Settings.mode` correctly:
- `ALNScanner/js/ui/uiManager.js:181` - `if (Settings.mode === 'blackmarket')`
- `ALNScanner/js/ui/uiManager.js:649` - `if (Settings.mode === 'blackmarket')`
- `ALNScanner/js/ui/uiManager.js:662` - `if (Settings.mode === 'blackmarket')`

**Tests:** Still use `Settings.stationMode`:
- `tests/unit/scanner/uiManager.test.js:70` - `global.Settings = { stationMode: 'blackmarket' };`
- `tests/unit/scanner/uiManager.test.js:424` - `global.Settings.stationMode = 'blackmarket';`
- `tests/unit/scanner/uiManager.test.js:519` - `global.Settings.stationMode = 'blackmarket';`
- Plus 20+ more occurrences throughout test file

**Impact:** 12 of 14 failures caused by this mismatch

---

### Finding 2: Anti-Pattern #1 - Testing Mock Behavior

**From testing-anti-patterns skill:**
> "NEVER test mock behavior. Test what the code does, not what the mocks do."

**Current Test Design (lines 18-100):**
```javascript
// Create elaborate mock DOM
mockElements = {};
mockDocument = {
  getElementById: jest.fn((id) => mockElements[id]),
  createElement: jest.fn((tag) => { /* mock element */ })
};

// Then assert on mock properties
expect(mockElements['resultValue'].textContent).toBe('$3,000');
```

**Problem:** Tests verify mock element properties match expectations, not that UIManager **behaves correctly**.

**Evidence:**
- Test line 1184: `expect(mockElements['resultValue'].textContent).toBe('$3,000')`
- Test line 1204: `expect(mockElements['resultValue'].textContent).toBe('$0')`
- Test line 527: `expect(valueElement.textContent).toBe('$15,000')`

These assertions test **what the mock captured**, not **what UIManager does**.

---

### Finding 3: UIManager Is Pure DOM Manipulation

**UIManager Architecture:**
- **Type:** Object literal with 18 public methods
- **Size:** 686 lines
- **Dependencies:** `Settings`, `DataManager`, `document` global
- **Pattern:** Direct DOM manipulation (no state, no return values)

**Public API:**
```javascript
const UIManager = {
  // Lifecycle
  init(),
  initErrorDisplay(),

  // Screen Management
  showScreen(screenName),

  // Updates (pure side effects)
  updateModeDisplay(),
  updateNavigationButtons(),
  updateTeamDisplay(teamId),
  updateSessionStats(),
  updateHistoryBadge(),
  updateHistoryStats(),

  // Rendering (pure side effects)
  renderScoreboard(),
  renderTeamDetails(teamId),
  renderTokenCard(transaction, bonusApplied),
  renderTransactions(transactions),

  // Filtering (returns filtered data)
  filterTransactions(searchTerm, modeFilter),

  // Notifications
  showError(message, duration),
  showToast(message, type, duration),
  showGroupCompletionNotification(groupName, bonus),
  showTokenResult(token, tokenId, isUnknown)
};
```

**Key Characteristics:**
1. **No internal state** (except `previousScreen` for navigation)
2. **All methods are side effects** (manipulate `document`)
3. **One pure function:** `filterTransactions()` returns filtered array
4. **Depends on globals:** `Settings.mode`, `DataManager` methods

---

### Finding 4: What Should We Actually Test?

**Current Tests:**
✅ Screen navigation logic (lines 347-408) - **GOOD**, tests behavior
❌ DOM element content (lines 520-530) - **BAD**, tests mock properties
❌ CSS class names (line 426) - **BAD**, tests mock style object

**What UIManager Actually Does:**
1. **Reads from:** `Settings.mode`, `DataManager` methods
2. **Writes to:** `document.getElementById(...)` elements
3. **Returns:** Nothing (except `filterTransactions()` returns data)

**Testing Challenge:**
- UIManager has **no return values** (pure side effects)
- Testing DOM manipulation requires either:
  - **Option A:** Real DOM (jsdom or browser)
  - **Option B:** Spy on `document.getElementById()` calls and verify correct IDs/values
  - **Option C:** Integration tests with full UI

---

### Finding 5: Failure Categorization

#### **Category 1: Field Standardization (12 failures)**
Simple fix: Change `Settings.stationMode` → `Settings.mode` in tests

| Test Description | Line | Issue |
|-----------------|------|-------|
| should update navigation buttons based on mode | 426 | Uses stationMode |
| should update session stats in blackmarket mode | 527 | Uses stationMode |
| should handle zero stats | 565 | Uses stationMode |
| should display team header with correct title | 1000+ | Uses stationMode |
| should render completed groups section | 1000+ | Uses stationMode |
| should render in-progress groups | 1000+ | Uses stationMode |
| should render ungrouped and unknown token sections | 1000+ | Uses stationMode |
| should display empty state when no transactions | 1000+ | Uses stationMode |
| should format values as currency in blackmarket mode | 1020+ | Uses stationMode |
| should format values as stars in detective mode | 1050+ | Uses stationMode |
| should filter transactions by mode | 1113 | Uses stationMode |
| should apply both search and mode filter | 1137 | Uses stationMode |

#### **Category 2: Mock Behavior Testing (2 failures + design issue)**
Requires test rewrite or architectural decision

| Test Description | Line | Issue |
|-----------------|------|-------|
| should display known token with all metadata | 1184 | Asserts on mockElements property |
| should display unknown token with error styling | 1204 | Asserts on mockElements property |

**Additional Issue:** After fixing stationMode, test #13 will still fail:
- Test sets `stationMode = 'blackmarket'`
- Expects `$3,000` (currency format)
- But implementation uses `Settings.mode`, which will be `undefined`
- Falls back to detective mode → displays `⭐⭐⭐`

---

## Testing Anti-Patterns Identified

### **Anti-Pattern #1: Testing Mock Behavior**
```javascript
// ❌ BAD (current tests)
const mockElements = { resultValue: { textContent: '' } };
UIManager.showTokenResult(token, 'rat001', false);
expect(mockElements['resultValue'].textContent).toBe('$3,000');
// ^ Testing what mock captured, not UIManager behavior
```

**Why This Is Wrong:**
- Test verifies mock worked, not that UIManager works
- If mock is incomplete, test passes with broken code
- If real DOM behavior differs, test won't catch it

### **Anti-Pattern #4: Incomplete Mocks**
```javascript
// Mock has textContent but missing:
// - innerHTML, classList, style properties used by real code
// - Element relationships (parentNode, children)
// - Event listeners
```

**Evidence:** Test failures show missing behavior:
- Expected: "$0", Received: "No Value"
- Mock doesn't implement full conditional logic

---

## Architectural Considerations

### **UIManager Testing Challenge**

**Problem:** UIManager is **pure side effects** (DOM manipulation)

**Three Testing Approaches:**

#### **Option A: Real DOM (jsdom)**
**Pros:**
- Tests verify actual DOM behavior
- Catches real browser issues
- No elaborate mock maintenance

**Cons:**
- Still testing implementation details (DOM structure)
- Brittle to CSS class/ID changes
- Doesn't test "does UI show correct info to user"

**Verdict:** Better than mocks, but still couples tests to DOM structure

#### **Option B: Spy-Based Testing**
**Pros:**
- Verifies UIManager called correct DOM methods
- Tests behavior: "did UIManager write $3,000 to resultValue element?"
- No mock DOM objects

**Cons:**
- Requires more sophisticated spies
- Still coupled to element IDs
- Doesn't verify user-visible outcome

**Example:**
```javascript
test('showTokenResult displays currency in blackmarket mode', () => {
  const getByIdSpy = jest.spyOn(document, 'getElementById');
  const mockValueEl = { textContent: '' };
  getByIdSpy.mockImplementation(id => {
    if (id === 'resultValue') return mockValueEl;
    return null;
  });

  global.Settings = { mode: 'blackmarket' }; // FIXED: use mode
  UIManager.showTokenResult(tokenWithRating3, 'rat001', false);

  // Verify behavior: UIManager wrote currency format
  expect(mockValueEl.textContent).toMatch(/^\$[\d,]+$/);
});
```

**Verdict:** Cleaner than current approach, still has coupling

#### **Option C: Integration Tests**
**Pros:**
- Tests full UI flow in real browser
- Verifies user-visible behavior
- Catches CSS/layout issues

**Cons:**
- Slower execution
- Requires E2E test infrastructure (Playwright exists!)
- More complex setup

**Verdict:** Best for critical UI paths, overkill for unit testing

---

## Recommended Fix Strategy

### **Phase 1: Quick Wins (Fixes 12/14 failures)**
**Time:** 15 minutes
**Risk:** LOW

1. Replace all `Settings.stationMode` with `Settings.mode` in test file
2. Update mock initialization (line 70):
```javascript
// BEFORE:
global.Settings = { stationMode: 'blackmarket' };

// AFTER:
global.Settings = { mode: 'blackmarket' };
```
3. Run tests - expect 12 failures → 0

### **Phase 2: Fix Remaining 2 Failures (Mock Behavior)**
**Time:** 30 minutes
**Risk:** MEDIUM

**Failure #13: "should display known token with all metadata"**
```javascript
// Current (line 1184):
expect(mockElements['resultValue'].textContent).toBe('$3,000');

// Problem: Test doesn't set Settings.mode, so implementation uses undefined
// Falls back to detective mode → displays ⭐⭐⭐

// Fix:
it('should display known token with all metadata', () => {
  global.Settings.mode = 'blackmarket'; // ADD THIS
  const token = { SF_ValueRating: 3, SF_MemoryType: 'Technical', SF_Group: 'MARCUS_SUCKS (x2)' };

  UIManager.showTokenResult(token, 'rat001', false);

  // After stationMode→mode fix, this will pass
  expect(mockElements['resultValue'].textContent).toBe('$3,000');
});
```

**Failure #14: "should display unknown token with error styling"**
```javascript
// Current (line 1204):
expect(mockElements['resultValue'].textContent).toBe('$0');

// Problem: Implementation line 652 says "No Value" for detective mode
// uiManager.js:649-653:
// if (Settings.mode === 'blackmarket') {
//   valueEl.textContent = '$0';
// } else {
//   valueEl.textContent = 'No Value';
// }

// Fix: Set mode to blackmarket
it('should display unknown token with error styling', () => {
  global.Settings.mode = 'blackmarket'; // ADD THIS

  UIManager.showTokenResult(null, 'UNKNOWN_123', true);

  expect(mockElements['resultValue'].textContent).toBe('$0'); // Now passes
});
```

### **Phase 3: Long-Term Fix (Eliminate Anti-Pattern #1)**
**Time:** 2-3 hours
**Risk:** MEDIUM-HIGH

**Option 3A: Convert to Spy-Based Tests (Recommended)**
- Remove elaborate mock DOM (lines 18-100)
- Use `jest.spyOn(document, 'getElementById')`
- Verify UIManager writes correct values to correct elements
- Tests become behavioral: "UIManager updates resultValue element with currency"

**Option 3B: Add jsdom + Keep Current Structure**
- Install jsdom (as original plan suggested)
- Replace mock DOM with real DOM
- Keep same assertions (still couples to structure)
- Easier short-term, but doesn't fix anti-pattern

**Option 3C: Move to E2E Integration Tests**
- Delete unit tests for rendering methods
- Create Playwright tests in `backend/tests/e2e/flows/`
- Test full scanner UI workflows
- Most robust, but loses fast unit test feedback

---

## Comparison: Original Plan vs Recommended Fix

### **Original Plan (lines 1348-1498)**
```
Step 1: Install jsdom
Step 2: Configure Jest projects (node vs jsdom)
Step 3: Update uiManager.test.js to use real DOM
Step 4: Update admin-monitoring-display.test.js similarly
Step 5-7: Commit
```

**Issues with Original Plan:**
1. Doesn't address `stationMode` → `mode` mismatch (12/14 failures)
2. Keeps DOM property assertions (Anti-Pattern #1)
3. Assumes jsdom fixes root cause (it doesn't)

### **Recommended Revised Plan**

**Task 3.2 (REVISED): Fix uiManager Test Failures**

**Root Cause:** Dual-layer failure
1. October 2025 field standardization not applied to tests (12/14 failures)
2. Tests assert on mock DOM properties instead of behavior (2/14 failures + design issue)

**Impact:** 14 test failures → 0

**Files:**
- Modify: `backend/tests/unit/scanner/uiManager.test.js`
- Reference: `docs/investigations/2025-10-30-task-3.2-uimanager-test-analysis.md`

**Step 1: Fix Field Standardization (12 failures → 0)**

Find and replace in test file:
```bash
cd backend
# Replace global.Settings initialization
sed -i 's/global\.Settings = { stationMode:/global.Settings = { mode:/' tests/unit/scanner/uiManager.test.js

# Replace all property accesses
sed -i 's/Settings\.stationMode/Settings.mode/g' tests/unit/scanner/uiManager.test.js
sed -i 's/stationMode:/mode:/g' tests/unit/scanner/uiManager.test.js
```

**Step 2: Verify fix**

```bash
npm test -- tests/unit/scanner/uiManager.test.js
```

**Expected Result:** 12 failures → 0 (only 2 remaining)

**Step 3: Fix Remaining 2 Failures (Mock Context)**

Update line ~1175 (before "should display known token" test):
```javascript
it('should display known token with all metadata', () => {
  global.Settings.mode = 'blackmarket'; // ADD: Set mode for test

  const token = {
    SF_ValueRating: 3,
    SF_MemoryType: 'Technical',
    SF_Group: 'MARCUS_SUCKS (x2)'
  };

  // ... rest of test unchanged
});
```

Update line ~1190 (before "should display unknown token" test):
```javascript
it('should display unknown token with error styling', () => {
  global.Settings.mode = 'blackmarket'; // ADD: Set mode for test

  UIManager.showTokenResult(null, 'UNKNOWN_123', true);

  // ... rest of test unchanged
});
```

**Step 4: Verify all tests pass**

```bash
npm test -- tests/unit/scanner/uiManager.test.js
```

**Expected Result:** 14 failures → 0 ✅

**Step 5: Commit**

```bash
git add tests/unit/scanner/uiManager.test.js
git commit -m "test: fix uiManager tests for October 2025 field standardization

Update all test references from Settings.stationMode to Settings.mode
per October 2025 field standardization (CLAUDE.md lines 44-48).

Fixes 12 failures caused by field name mismatch.

Remaining 2 failures fixed by setting Settings.mode in test context
to match implementation's conditional logic (uiManager.js:649, 662).

All 14 uiManager test failures now resolved."
```

**Step 6: Document Anti-Pattern for Future Cleanup**

Create: `docs/tech-debt/2025-10-30-uimanager-test-anti-pattern.md`

```markdown
# UIManager Test Anti-Pattern: Testing Mock Behavior

## Issue

Current uiManager tests assert on mock DOM element properties:
- `expect(mockElements['resultValue'].textContent).toBe('$3,000')`
- Violates Anti-Pattern #1: Testing mock behavior, not real behavior

## Impact

- Tests verify mock worked, not that UIManager works
- Brittle to DOM structure changes
- Doesn't catch real browser behavior differences

## Recommended Fix

**Option A (Recommended):** Convert to spy-based behavioral tests
**Option B:** Add jsdom for real DOM (still couples to structure)
**Option C:** Move to E2E integration tests (most robust)

See: docs/investigations/2025-10-30-task-3.2-uimanager-test-analysis.md

## Priority

**P2 - Medium:** Tests work after field standardization fix.
Not blocking, but improves test quality and maintainability.

## Estimated Effort

2-3 hours for full rewrite to behavioral tests.
```

**Step 7: Final Verification**

Run full unit test suite:
```bash
npm run test:unit
```

Expected: uiManager 14 failures → 0, no regressions elsewhere

---

## Impact Analysis

### **Test Count Changes**
- **Before:** 31 passing, 14 failing (45 total)
- **After:** 45 passing, 0 failing (45 total)
- **Net change:** +14 passing tests

### **Overall Baseline Impact**
- **Baseline:** 38 unit test failures
- **After Task 3.2 (revised):** 38 - 14 = **24 unit test failures**
- **Improvement:** 37% reduction in unit test failures

### **Tier 3 Revised Estimates**
- **Task 3.1:** Service reset listeners (~0 direct fixes, enables future)
- **Task 3.2 (revised):** 14 test fixes (down from 19 in original plan)
- **Task 3.3:** 7 test fixes (settings.test.js)
- **Total:** ~21 test fixes (vs 26 in original plan)

### **Admin-monitoring-display.test.js**
**Original plan** said to fix this (5 failures) in Task 3.2.

**Investigation needed:** Are those failures also from `stationMode` → `mode`?

Let me check quickly:
